--echo #
--echo # MDEV-28741 Disable query cache on Spider tables to avoid cache inconsistency
--echo #

--disable_query_log
--disable_result_log
--source ../t/test_init.inc
--enable_query_log
--enable_result_log

--connection child2_1
CREATE DATABASE auto_test_remote;
USE auto_test_remote;

DROP TABLE IF EXISTS tbl_a;
eval CREATE TABLE tbl_a (
  id int NOT NULL AUTO_INCREMENT,
  name varchar(255) DEFAULT NULL,
  PRIMARY KEY (id)
) $CHILD2_1_ENGINE $CHILD2_1_CHARSET;

INSERT INTO tbl_a (name) VALUES ('remote_record_1'), ('remote_record_2'), ('remote_record_3');
-- echo

--connection child2_2
CREATE DATABASE auto_test_remote2;
USE auto_test_remote2;

DROP TABLE IF EXISTS tbl_a;
eval CREATE TABLE tbl_a (
  id int NOT NULL AUTO_INCREMENT,
  name varchar(255) DEFAULT NULL,
  PRIMARY KEY (id)
) $CHILD2_2_ENGINE $CHILD2_2_CHARSET;

INSERT INTO tbl_a (name) VALUES ('remote_2_record_1'), ('remote_2_record_2'), ('remote_2_record_3');
-- echo

--connection master_1
CREATE DATABASE auto_test_local;
USE auto_test_local;

eval CREATE TABLE tbl_a (
  id int NOT NULL AUTO_INCREMENT,
  name varchar(255) DEFAULT NULL,
  PRIMARY KEY (id)
) $MASTER_1_ENGINE $MASTER_1_CHARSET COMMENT='table "tbl_a"'
PARTITION BY HASH(id) (
  PARTITION pt1 COMMENT='srv "s_2_1"',
  PARTITION pt2 COMMENT='srv "s_2_2"'
);
-- echo

SET GLOBAL query_cache_type=ON;
SET LOCAL query_cache_type=ON;

SHOW variables like '%query_cache%';
-- echo

SELECT SQL_CACHE id, name FROM tbl_a;
-- echo

--connection child2_1
USE auto_test_remote;
DELETE FROM tbl_a WHERE name = "remote_record_1";
-- echo

--connection master_1
USE auto_test_local;
-- echo
SHOW variables like '%query_cache%';
-- echo

SELECT id, name FROM tbl_a;
-- echo

DROP DATABASE auto_test_local;

--connection child2_1
DROP DATABASE auto_test_remote;

--connection child2_2
DROP DATABASE auto_test_remote2;

--disable_query_log
--disable_result_log
--source ../t/test_deinit.inc
--enable_query_log
--enable_result_log
